<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Acesso Exclusivo</title>
    <meta name="description" content="Conteúdo exclusivo para membros. Entre para acessar." />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="preconnect" href="https://connect.facebook.net" crossorigin />

    <style>
      :root{--bg:#0b0b0f;--card:#12121a;--txt:#f2f2f5;--mut:#a0a0b2;--brand:#8247ff;--bar:#22223a}
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
      .wrap{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:24px}
      .card{max-width:560px;width:100%;background:linear-gradient(180deg,#141420,#0f0f18);border:1px solid #232334;border-radius:20px;padding:28px;box-shadow:0 10px 40px rgba(0,0,0,.35);text-align:center;position:relative;overflow:hidden}
      h1{margin:6px 0 10px;font-size:28px}
      p{margin:0 0 12px;color:var(--mut)}
      .status{display:flex;gap:10px;align-items:center;justify-content:center;min-height:22px}
      .dot{width:7px;height:7px;border-radius:999px;background:var(--brand);box-shadow:0 0 10px rgba(130,71,255,.6)}
      .bar{height:10px;background:var(--bar);border-radius:999px;overflow:hidden;margin:16px 0 8px}
      .fill{height:100%;width:0;background:linear-gradient(90deg,#6a3dff,#9a73ff);box-shadow:0 0 20px rgba(130,71,255,.5)}
      .hint{font-size:12px;color:#8a8aa0}
      .cta{display:inline-block;margin-top:12px;padding:12px 16px;background:var(--brand);border-radius:12px;color:#fff;text-decoration:none;font-weight:700}
      .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    </style>

    <!-- Meta Pixel -->
    <script>
      !(function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
        n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}
      )(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');

      fbq('init','1108333617311057');
      fbq('track','PageView');
      fbq('track','ViewContent',{page:'pressell'});
    </script>

    <!-- Utmify Pixel -->
    <script>
      window.pixelId = "68a6fbc1891f5161a638818f";
      var a = document.createElement("script");
      a.async = true; a.defer = true;
      a.src = "https://cdn.utmify.com.br/scripts/pixel/pixel.js";
      document.head.appendChild(a);
    </script>
  </head>

  <body>
    <div class="wrap">
      <div class="card">
        <h1>Conferindo acesso…</h1>
        <p class="hint" id="msg">Confirmando sua idade</p>
        <div class="status" aria-hidden="true">
          <span class="dot"></span>
          <span id="statusHint">Deixando ambiente seguro</span>
        </div>
        <div class="bar"><div class="fill" id="fill"></div></div>
        <p class="hint">Se não redirecionar, <a id="cta" class="cta" href="#" rel="noopener noreferrer">ir agora</a>.</p>
        <span id="sr" class="sr-only">0% concluído</span>
      </div>
    </div>

    <noscript>
      <img height="1" width="1" style="display:none"
           src="https://www.facebook.com/tr?id=1108333617311057&ev=PageView&noscript=1"/>
      <meta http-equiv="refresh" content="1.5;url=https://t.me/vazadosoficialvip1_bot">
    </noscript>

    <script>
      // =================== CONFIG ===================
      const API  = "https://web-production-29ac.up.railway.app"; // sua API
      const BOT  = "vazadosoficialvip1_bot";                      // sem @
      const REDIRECT_DELAY_MS = 800;                               // janela pro Pixel
      // ==============================================

      // UUID v4 simples p/ click_id
      function uuidv4(){
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
          const r = Math.random()*16|0, v = c=='x'?r:(r&0x3|0x8);
          return v.toString(16);
        });
      }

      // UI: barra e mensagens
      const fill = document.getElementById('fill');
      const sr   = document.getElementById('sr');
      const msg  = document.getElementById('msg');
      const hint = document.getElementById('statusHint');
      const t0   = performance.now();
      (function anim(ts){
        const pct = Math.min(100, (ts - t0) / REDIRECT_DELAY_MS * 100);
        fill.style.width = pct + '%';
        sr.textContent   = Math.round(pct) + '% concluído';
        if (pct < 100) requestAnimationFrame(anim);
      })(t0);
      setTimeout(()=>{ msg.textContent = "Liberando acesso"; }, 500);
      setTimeout(()=>{ hint.textContent= "Preparando redirecionamento"; }, 650);

      // Coleta UTMs/fbclid
      const qs = new URLSearchParams(location.search);
      const tracking = {
        fbclid: qs.get('fbclid'),
        utm_source: qs.get('utm_source'),
        utm_campaign: qs.get('utm_campaign'),
        utm_medium: qs.get('utm_medium'),
        utm_content: qs.get('utm_content'),
        utm_term: qs.get('utm_term'),
        src: qs.get('src'),
        sck: qs.get('sck')
      };
      const hasTracking = Object.values(tracking).some(v => !!v);

      // click_id para dedupe e start param
      const clickId = uuidv4();

      // Monta destinos
      const hash = location.hash || '';
      const baseHTTPS = `https://t.me/${BOT}`;
      const mkStart = (payload) => `${baseHTTPS}?start=${encodeURIComponent(payload)}${hash}`;
      const tgDeep   = (payload) => `tg://resolve?domain=${encodeURIComponent(BOT)}&start=${encodeURIComponent(payload)}`;

      // CTA sempre aponta pro destino calculado (atualiza depois)
      const cta = document.getElementById('cta');
      let startPayload = null;

      // Dispara Lead e navega
      function go(payload){
        try { fbq('track','Lead',{ destination:'telegram', event_id: clickId }); } catch(e) {}
        // HTTPS primeiro
        const httpsUrl = mkStart(payload);
        window.location.replace(httpsUrl);
        // fallback tenta abrir app nativo
        setTimeout(()=>{ window.location.href = tgDeep(payload); }, 350);
      }

      // Salva tracking na sua API (se disponível) e decide payload
        async function bootstrap(){
          try {
            startPayload = null;

          if (hasTracking) {
            // envia tudo + click_id
            const r = await fetch(`${API}/api/save-tracking`, {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ ...tracking, click_id: clickId })
            });
            const data = await r.json().catch(()=> ({}));
            if (data && data.short_id) startPayload = data.short_id;

            // fallback para fbclid gigante → encurta
            if (!startPayload && tracking.fbclid && tracking.fbclid.length > 60) {
              const rf = await fetch(`${API}/api/save-fbclid`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ fbclid: tracking.fbclid, click_id: clickId })
              });
              const df = await rf.json().catch(()=> ({}));
              if (df && df.short_id) startPayload = `fb_${df.short_id}`;
            }
          }

          // payload padrão caso a API não retorne short_id
          if (!startPayload) {
            const utms = location.search ? location.search.substring(1) : "";
            startPayload = `${clickId}__${utms}`;
          }

          // atualiza CTA e agenda redirect
          cta.href = mkStart(startPayload);
          setTimeout(()=> go(startPayload), REDIRECT_DELAY_MS);

        } catch(err){
          // falhou API → usa payload básico
            const utms = location.search ? location.search.substring(1) : "";
            startPayload = `${clickId}__${utms}`;
            cta.href = mkStart(startPayload);
            setTimeout(()=> go(startPayload), REDIRECT_DELAY_MS);
          }
        }

        // CTA manual
        cta.addEventListener('click', (e)=>{ if(startPayload){ e.preventDefault(); go(startPayload); } });

        // start
        bootstrap();

      // Hard fallback: se fbq não carregar, segue viagem
      setTimeout(()=>{ if (!window.fbq) go(`${clickId}__${location.search?location.search.substring(1):""}`); }, REDIRECT_DELAY_MS + 900);
    </script>
  </body>
</html>
