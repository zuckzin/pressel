<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Acesso Exclusivo</title>
    <meta name="description" content="Conteúdo exclusivo para membros. Entre para acessar." />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="preconnect" href="https://connect.facebook.net" crossorigin />

    <style>
      :root{
        --bg:#0b0b0f;--card:#12121a;--txt:#f2f2f5;--mut:#a0a0b2;
        --brand:#8247ff;--bar:#22223a;--glow:rgba(130,71,255,.55)
      }
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--txt);
        font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
      .wrap{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:24px}
      .card{
        max-width:560px;width:100%;
        background:linear-gradient(180deg,#141420,#0f0f18);
        border:1px solid #232334;border-radius:20px;padding:28px;
        box-shadow:0 10px 40px rgba(0,0,0,.35);text-align:center;position:relative;overflow:hidden
      }
      h1{margin:6px 0 10px;font-size:28px}
      p{margin:0 0 12px;color:var(--mut)}
      .status{display:flex;gap:10px;align-items:center;justify-content:center;min-height:22px}
      .dot{width:7px;height:7px;border-radius:999px;background:var(--brand);box-shadow:0 0 10px var(--glow)}
      .bar{height:10px;background:var(--bar);border-radius:999px;overflow:hidden;margin:16px 0 8px}
      .fill{
        height:100%;width:0;background:linear-gradient(90deg,#6a3dff,#9a73ff);
        box-shadow:0 0 20px var(--glow)
      }
      .hint{font-size:12px;color:#8a8aa0}
      .cta{display:inline-block;margin-top:12px;padding:12px 16px;background:var(--brand);
        border-radius:12px;color:#fff;text-decoration:none;font-weight:700}
      .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    </style>

    <!-- Meta Pixel (PageView + ViewContent) -->
    <script>
      !(function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
        n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}
      )(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');

      fbq('init','2140822269745619');                 // seu Pixel
      fbq('track','PageView');                        // visita
      fbq('track','ViewContent',{page:'pressell'});   // ver conteúdo
    </script>

    <!-- Utmify Pixel -->
    <script>
      window.pixelId = "68a6fbc1891f5161a638818f";
      (function(){
        var a = document.createElement("script");
        a.async = true; a.defer = true;
        a.src = "https://cdn.utmify.com.br/scripts/pixel/pixel.js";
        document.head.appendChild(a);
      })();
    </script>
  </head>

  <body>
    <div class="wrap">
      <main class="card" role="main" aria-live="polite">
        <h1>Conferindo acesso…</h1>

        <div class="status" aria-hidden="true">
          <span class="dot"></span>
          <span id="msg">Confirmando sua idade</span>
        </div>

        <div class="bar" aria-hidden="true"><div class="fill" id="fill"></div></div>

        <p class="hint" id="sub">Deixando ambiente seguro</p>
        <p class="hint">Se não redirecionar, <a id="cta" class="cta" href="#" rel="noopener noreferrer">ir agora</a>.</p>

        <span id="sr" class="sr-only">0% concluído</span>
      </main>
    </div>

    <!-- Fallback sem JS (usa o MESMO pixel id do script acima) -->
    <noscript>
      <img height="1" width="1" style="display:none"
           src="https://www.facebook.com/tr?id=2140822269745619&ev=PageView&noscript=1"/>
      <meta http-equiv="refresh" content="1.5;url=https://t.me/irmasoliveiratrans1_bot">
    </noscript>

    <script>
      // =================== CONFIG ===================
      const API  = "https://web-production-29ac.up.railway.app"; // tracking API (não alterar)
      const BOT  = "irmasoliveiratrans1_bot";                     // sem @
      const REDIRECT_DELAY_MS = 900;                              // janela pro Pixel
      // ==============================================

      // Util
      function uuidv4(){
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
          const r = Math.random()*16|0, v = c=='x'?r:(r&0x3|0x8);
          return v.toString(16);
        });
      }
      function entriesToObject(sp){
        const o = {};
        for (const [k,v] of sp.entries()) o[k] = v;
        return o;
      }

      // Animação
      const fill = document.getElementById('fill');
      const sr   = document.getElementById('sr');
      const msg  = document.getElementById('msg');
      const sub  = document.getElementById('sub');
      const t0   = performance.now();
      (function anim(ts){
        const pct = Math.min(100, (ts - t0) / REDIRECT_DELAY_MS * 100);
        fill.style.width = pct + '%';
        sr.textContent   = Math.round(pct) + '% concluído';
        if (pct < 100) requestAnimationFrame(anim);
      })(t0);
      setTimeout(()=>{ msg.textContent = "Deixando ambiente seguro"; }, 350);
      setTimeout(()=>{ msg.textContent = "Liberando acesso"; sub.textContent="Preparando redirecionamento"; }, 650);

      // Captura UNIVERSAL de parâmetros
      const qs       = new URLSearchParams(location.search);
      const allParams= entriesToObject(qs);            // <- tudo
      const hasTracking = Object.keys(allParams).length > 0;

      // click_id para dedupe e start param
      const clickId = uuidv4();

      // Destinos
      const hash = location.hash || '';
      const baseHTTPS = `https://t.me/${BOT}`;
      const mkStart  = (payload) => `${baseHTTPS}?start=${encodeURIComponent(payload)}${hash}`;
      const mkDeepTG = (payload) => `tg://resolve?domain=${encodeURIComponent(BOT)}&start=${encodeURIComponent(payload)}`;

      // Dispara eventos e navega
      function firePressellRedirect(payloadRef){
        try {
          fbq('trackCustom','PressellRedirect', {
            hasTracking,
            fbclid: allParams.fbclid || null,
            utm_source: allParams.utm_source || null,
            utm_campaign: allParams.utm_campaign || null,
            utm_medium: allParams.utm_medium || null,
            utm_content: allParams.utm_content || null,
            utm_term: allParams.utm_term || null,
            event_id: clickId,
            start_payload: (payloadRef || '').toString().slice(0,100)
          });
        } catch(e) {}
      }
      function go(payload){
        firePressellRedirect(payload);
        try { fbq('track','Lead',{ destination:'telegram', event_id: clickId }); } catch(e) {}
        const httpsUrl = mkStart(payload);
        window.location.replace(httpsUrl);
        // tentativa de abrir app nativo
        setTimeout(()=>{ window.location.href = mkDeepTG(payload); }, 400);
      }

      const cta = document.getElementById('cta');

      // Fluxo principal
      (function bootstrap(){
        // Timer de failsafe: nunca travar conversão
        const failSafe = setTimeout(()=>{
          const utms = location.search ? location.search.substring(1) : "";
          const payload = `${clickId}__${utms}`;
          cta.href = mkStart(payload);
          go(payload);
        }, REDIRECT_DELAY_MS + 1200);

        (async ()=>{
          try {
            let startPayload = null;

            if (hasTracking) {
              // envia TUDO + click_id
              const r = await fetch(`${API}/api/save-tracking`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ ...allParams, click_id: clickId })
              });
              if (r.ok) {
                const data = await r.json().catch(()=> ({}));
                if (data && data.short_id) startPayload = data.short_id;
              }

              // fallback fbclid gigante
              if (!startPayload && allParams.fbclid && allParams.fbclid.length > 60) {
                const rf = await fetch(`${API}/api/save-fbclid`, {
                  method: 'POST',
                  headers:{'Content-Type':'application/json'},
                  body: JSON.stringify({ fbclid: allParams.fbclid, click_id: clickId })
                });
                if (rf.ok) {
                  const df = await rf.json().catch(()=> ({}));
                  if (df && df.short_id) startPayload = `fb_${df.short_id}`;
                }
              }
            }

            // payload padrão caso a API não retorne short_id
            if (!startPayload) {
              const utms = location.search ? location.search.substring(1) : "";
              startPayload = `${clickId}__${utms}`;
            }

            // atualiza CTA e agenda redirect
            cta.href = mkStart(startPayload);
            setTimeout(()=>{ clearTimeout(failSafe); go(startPayload); }, REDIRECT_DELAY_MS);

          } catch(err){
            // falhou API → usa payload básico
            const utms = location.search ? location.search.substring(1) : "";
            const payload = `${clickId}__${utms}`;
            cta.href = mkStart(payload);
            setTimeout(()=>{ clearTimeout(failSafe); go(payload); }, REDIRECT_DELAY_MS);
          }
        })();
      })();

      // Evita dupla navegação no click manual
      cta.addEventListener('click', (e)=>{
        e.preventDefault();
        const href = cta.getAttribute('href') || '';
        const qsIdx = href.indexOf('start=');
        const payload = qsIdx>-1 ? decodeURIComponent(href.slice(qsIdx+6)) : `${clickId}__${location.search?location.search.substring(1):""}`;
        go(payload);
      });

      // Hard fallback: se fbq não carregar, segue viagem mesmo assim
      setTimeout(()=>{ if (typeof window.fbq !== 'function') {
        const utms = location.search ? location.search.substring(1) : "";
        go(`${clickId}__${utms}`);
      }}, REDIRECT_DELAY_MS + 900);
    </script>
  </body>
</html>
