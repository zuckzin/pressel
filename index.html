<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Acesso Exclusivo</title>
    <meta name="description" content="Conteúdo exclusivo para membros. Entre para acessar." />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="preconnect" href="https://connect.facebook.net" crossorigin />

    <style>
      :root{--bg:#0b0b0f;--card:#12121a;--txt:#f2f2f5;--mut:#a0a0b2;--brand:#8247ff;--bar:#22223a}
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
      .wrap{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:24px}
      .card{max-width:560px;width:100%;background:linear-gradient(180deg,#141420,#0f0f18);border:1px solid #232334;border-radius:20px;padding:28px;box-shadow:0 10px 40px rgba(0,0,0,.35);text-align:center;position:relative;overflow:hidden}
      h1{margin:6px 0 10px;font-size:28px}
      p{margin:0 0 12px;color:var(--mut)}
      .status{display:flex;gap:10px;align-items:center;justify-content:center;min-height:22px}
      .dot{width:7px;height:7px;border-radius:999px;background:var(--brand);box-shadow:0 0 10px rgba(130,71,255,.6)}
      .bar{height:10px;background:var(--bar);border-radius:999px;overflow:hidden;margin:16px 0 8px}
      .fill{height:100%;width:0;background:linear-gradient(90deg,#6a3dff,#9a73ff);box-shadow:0 0 20px rgba(130,71,255,.5)}
      .hint{font-size:12px;color:#8a8aa0}
      .cta{display:inline-block;margin-top:12px;padding:12px 16px;background:var(--brand);border-radius:12px;color:#fff;text-decoration:none;font-weight:700}
      .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    </style>

    <!-- Meta Pixel (PageView + ViewContent) -->
    <script>
      !(function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
        n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}
      )(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');

      fbq('init','1108333617311057');                 // <-- seu Pixel ID
      fbq('track','PageView');                        // visita
      fbq('track','ViewContent',{page:'pressell'});   // ver conteúdo
    </script>
    <noscript>
      <img height="1" width="1" style="display:none"
           src="https://www.facebook.com/tr?id=1108333617311057&ev=PageView&noscript=1"/>
      <meta http-equiv="refresh" content="1.5;url=https://t.me/vazadosoficial00_bot">
    </noscript>
  </head>

  <body>
    <div class="wrap">
      <main class="card" role="main" aria-live="polite">
        <h1>Conferindo acesso…</h1>
        <div class="status" aria-hidden="true">
          <span class="dot"></span>
          <span id="msg">Confirmando sua idade</span>
        </div>
        <div class="bar" aria-hidden="true"><div class="fill" id="fill"></div></div>
        <p class="hint" id="hint">Deixando ambiente seguro</p>
        <p class="hint">Se não redirecionar, <a id="cta" class="cta" href="#" rel="noopener noreferrer">ir agora</a>.</p>
        <span id="sr" class="sr-only">0% concluído</span>
      </main>
    </div>

    <script>
      // =================== CONFIG ===================
      const API_URL  = "https://web-production-29ac.up.railway.app"; // sua API
      const BOT_NAME = "vazadosoficialvip1_bot="; // <-- sem @ (apenas o username)
      const REDIRECT_DELAY_MS = 800; // janela pro Pixel subir eventos
      // ==============================================

      // UUID v4 simples p/ click_id
      function uuidv4(){
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
          const r = Math.random()*16|0, v = c=='x'?r:(r&0x3|0x8);
          return v.toString(16);
        });
      }

      // Captura UTMs e fbclid
      const params = new URLSearchParams(location.search);
      const trackingData = {
        fbclid: params.get('fbclid'),
        utm_source: params.get('utm_source'),
        utm_campaign: params.get('utm_campaign'),
        utm_medium: params.get('utm_medium'),
        utm_content: params.get('utm_content'),
        utm_term: params.get('utm_term'),
        src: params.get('src'),
        sck: params.get('sck')
      };
      const hasTracking = trackingData.fbclid || trackingData.utm_source || trackingData.utm_campaign;

      // Monta destinos
      const hash = location.hash || '';
      const baseTme = `https://t.me/${vazadosoficialvip1_bot}`;
      const makeStart = (s) => `${baseTme}?start=${encodeURIComponent(s)}${hash}`;
      const tgDeep = `tg://resolve?domain=${encodeURIComponent(BOT_NAME)}&start=`;
      
      // UI: barra/mensagens acessíveis
      const fill = document.getElementById('fill');
      const msg  = document.getElementById('msg');
      const sr   = document.getElementById('sr');
      const startTs = performance.now();
      (function anim(ts){
        const pct = Math.min(100, (ts - startTs) / REDIRECT_DELAY_MS * 100);
        fill.style.width = pct + '%';
        sr.textContent = Math.round(pct) + '% concluído';
        if (pct < 100) requestAnimationFrame(anim);
      })(startTs);
      setTimeout(()=>{ msg.textContent = "Deixando ambiente seguro"; }, 350);
      setTimeout(()=>{ msg.textContent = "Liberando acesso"; }, 650);

      // click_id para dedupe (Lead/Purchase)
      const clickId = uuidv4();

      // Dispara Lead + redireciona
      async function go(finalStartPayload){
        try {
          fbq('track','Lead',{ destination:'telegram', event_id: clickId });
        } catch(e) {}
        setTimeout(()=>{
          const httpsUrl = makeStart(finalStartPayload);
          window.location.replace(httpsUrl);
          // tentativa de abrir app Telegram
          setTimeout(()=>{ window.location.href = tgDeep + encodeURIComponent(finalStartPayload); }, 350);
        }, 220);
      }

      // Integração com sua API (mantém seu fluxo + envia click_id junto)
      async function run(){
        try {
          let shortId = null;

          if (hasTracking) {
            const body = { ...trackingData, click_id: clickId }; // envia click_id (se sua API ignorar, sem problemas)
            const r = await fetch(`${API_URL}/api/save-tracking`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });
            const data = await r.json().catch(()=>({}));
            if (data && data.short_id) shortId = data.short_id;
            else if (trackingData.fbclid && trackingData.fbclid.length > 60) {
              // fallback fbclid longo
              const rf = await fetch(`${API_URL}/api/save-fbclid`, {
                method: 'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ fbclid: trackingData.fbclid, click_id: clickId })
              });
              const df = await rf.json().catch(()=>({}));
              if (df && df.short_id) shortId = `fb_${df.short_id}`;
            }
          }

          // payload final: prioriza short_id da sua API; senão usa padrão "<click_id>__utm..."
          const fallbackPayload = clickId + "__" + (location.search ? location.search.substring(1) : "");
          const startPayload = shortId || fallbackPayload;

          // espera mínima p/ consolidar eventos
          setTimeout(()=> go(startPayload), REDIRECT_DELAY_MS);
        } catch (e) {
          const fallbackPayload = clickId + "__" + (location.search ? location.search.substring(1) : "");
          setTimeout(()=> go(fallbackPayload), REDIRECT_DELAY_MS);
        }
      }

      // CTA manual se algo bloquear auto-redirect
      document.getElementById('cta').addEventListener('click', (e)=>{ e.preventDefault(); run(); });

      // start automático
      run();

      // Hard fallback: sem fbq, redireciona mesmo assim
      setTimeout(()=>{ if (!window.fbq) go(clickId); }, REDIRECT_DELAY_MS + 900);
    </script>
  </body>
</html>
